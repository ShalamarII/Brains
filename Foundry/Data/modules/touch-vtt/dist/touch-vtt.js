(()=>{var t={308:()=>{let t;!function(t){"use strict";let e=function(){function t(){this._dropEffect="move",this._effectAllowed="all",this._data={}}return Object.defineProperty(t.prototype,"dropEffect",{get:function(){return this._dropEffect},set:function(t){this._dropEffect=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"effectAllowed",{get:function(){return this._effectAllowed},set:function(t){this._effectAllowed=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"types",{get:function(){return Object.keys(this._data)},enumerable:!0,configurable:!0}),t.prototype.clearData=function(t){null!==t?delete this._data[t.toLowerCase()]:this._data={}},t.prototype.getData=function(t){let e=t.toLowerCase(),n=this._data[e];return"text"===e&&null==n&&(n=this._data["text/plain"]),n||""},t.prototype.setData=function(t,e){this._data[t.toLowerCase()]=e},t.prototype.setDragImage=function(t,e,s){let o=n._instance;o._imgCustom=t,o._imgOffset={x:e,y:s}},t}();t.DataTransfer=e;let n=function(){function t(){if(this._lastClick=0,t._instance)throw"DragDropTouch instance already created.";let e=!1;if(document.addEventListener("test",(function(){}),{get passive(){return e=!0,!0}}),navigator.maxTouchPoints){let t=document,n=this._touchstart.bind(this),s=this._touchmove.bind(this),o=this._touchend.bind(this),i=!!e&&{passive:!1,capture:!1};t.addEventListener("touchstart",n,i),t.addEventListener("touchmove",s,i),t.addEventListener("touchend",o),t.addEventListener("touchcancel",o)}}return t.getInstance=function(){return t._instance},t.prototype._touchstart=function(e){let n=this;if(this._shouldHandle(e)){this._reset();let s=this._closestDraggable(e.target);s&&(this._dispatchEvent(e,"mousemove",e.target)||this._dispatchEvent(e,"mousedown",e.target)||(this._dragSource=s,this._ptDown=this._getPoint(e),this._lastTouch=e,setTimeout((function(){n._dragSource===s&&null===n._img&&n._dispatchEvent(e,"contextmenu",s)&&n._reset()}),t._CTXMENU),t._ISPRESSHOLDMODE&&(this._pressHoldInterval=setTimeout((function(){n._isDragEnabled=!0,n._touchmove(e)}),t._PRESSHOLDAWAIT))))}},t.prototype._touchmove=function(t){if(this._shouldCancelPressHoldMove(t))this._reset();else if(this._shouldHandleMove(t)||this._shouldHandlePressHoldMove(t)){let e=this._getTarget(t);if(this._dispatchEvent(t,"mousemove",e))return this._lastTouch=t,void t.preventDefault();if(this._dragSource&&!this._img&&this._shouldStartDragging(t)){if(this._dispatchEvent(this._lastTouch,"dragstart",this._dragSource))return void(this._dragSource=null);this._createImage(t),this._dispatchEvent(t,"dragenter",e)}this._img&&(this._lastTouch=t,t.preventDefault(),this._dispatchEvent(t,"drag",this._dragSource),e!==this._lastTarget&&(this._dispatchEvent(this._lastTouch,"dragleave",this._lastTarget),this._dispatchEvent(t,"dragenter",e),this._lastTarget=e),this._moveImage(t),this._isDropZone=this._dispatchEvent(t,"dragover",e))}},t.prototype._touchend=function(t){if(this._shouldHandle(t)){if(this._dispatchEvent(this._lastTouch,"mouseup",t.target))return void t.preventDefault();this._img||(this._dragSource=null,this._lastClick=Date.now()),this._destroyImage(),this._dragSource&&(t.type.indexOf("cancel")<0&&this._isDropZone&&this._dispatchEvent(this._lastTouch,"drop",this._lastTarget),this._dispatchEvent(this._lastTouch,"dragend",this._dragSource),this._reset())}},t.prototype._shouldHandle=function(t){return t&&!t.defaultPrevented&&t.touches&&t.touches.length<2},t.prototype._shouldHandleMove=function(e){return!t._ISPRESSHOLDMODE&&this._shouldHandle(e)},t.prototype._shouldHandlePressHoldMove=function(e){return t._ISPRESSHOLDMODE&&this._isDragEnabled&&e&&e.touches&&e.touches.length},t.prototype._shouldCancelPressHoldMove=function(e){return t._ISPRESSHOLDMODE&&!this._isDragEnabled&&this._getDelta(e)>t._PRESSHOLDMARGIN},t.prototype._shouldStartDragging=function(e){let n=this._getDelta(e);return n>t._THRESHOLD||t._ISPRESSHOLDMODE&&n>=t._PRESSHOLDTHRESHOLD},t.prototype._reset=function(){this._destroyImage(),this._dragSource=null,this._lastTouch=null,this._lastTarget=null,this._ptDown=null,this._isDragEnabled=!1,this._isDropZone=!1,this._dataTransfer=new e,clearInterval(this._pressHoldInterval)},t.prototype._getPoint=function(t,e){return t&&t.touches&&(t=t.touches[0]),{x:e?t.pageX:t.clientX,y:e?t.pageY:t.clientY}},t.prototype._getDelta=function(e){if(t._ISPRESSHOLDMODE&&!this._ptDown)return 0;let n=this._getPoint(e);return Math.abs(n.x-this._ptDown.x)+Math.abs(n.y-this._ptDown.y)},t.prototype._getTarget=function(t){let e=this._getPoint(t),n=document.elementFromPoint(e.x,e.y);for(;n&&"none"==getComputedStyle(n).pointerEvents;)n=n.parentElement;return n},t.prototype._createImage=function(e){this._img&&this._destroyImage();let n=this._imgCustom||this._dragSource;if(this._img=n.cloneNode(!0),this._copyStyle(n,this._img),this._img.style.top=this._img.style.left="-9999px",!this._imgCustom){let s=n.getBoundingClientRect(),o=this._getPoint(e);this._imgOffset={x:o.x-s.left,y:o.y-s.top},this._img.style.opacity=t._OPACITY.toString()}this._moveImage(e),document.body.appendChild(this._img)},t.prototype._destroyImage=function(){this._img&&this._img.parentElement&&this._img.parentElement.removeChild(this._img),this._img=null,this._imgCustom=null},t.prototype._moveImage=function(t){let e=this;requestAnimationFrame((function(){if(e._img){let n=e._getPoint(t,!0),s=e._img.style;s.position="absolute",s.pointerEvents="none",s.zIndex="999999",s.left=Math.round(n.x-e._imgOffset.x)+"px",s.top=Math.round(n.y-e._imgOffset.y)+"px"}}))},t.prototype._copyProps=function(t,e,n){for(let s=0;s<n.length;s++){let o=n[s];t[o]=e[o]}},t.prototype._copyStyle=function(e,n){if(t._rmvAtts.forEach((function(t){n.removeAttribute(t)})),e instanceof HTMLCanvasElement){let t=e,s=n;s.width=t.width,s.height=t.height,s.getContext("2d").drawImage(t,0,0)}let s=getComputedStyle(e);for(let t=0;t<s.length;t++){let e=s[t];e.indexOf("transition")<0&&(n.style[e]=s[e])}n.style.pointerEvents="none";for(let t=0;t<e.children.length;t++)this._copyStyle(e.children[t],n.children[t])},t.prototype._setOffsetAndLayerProps=function(t,e){let n;void 0===t.offsetX&&(n=e.getBoundingClientRect(),t.offsetX=t.clientX-n.x,t.offsetY=t.clientY-n.y),void 0===t.layerX&&(n=n||e.getBoundingClientRect(),t.layerX=t.pageX-n.left,t.layerY=t.pageY-n.top)},t.prototype._dispatchEvent=function(e,n,s){if(e&&s){let o=new Event(n,{bubbles:!0,cancelable:!0}),i=e.touches?e.touches[0]:e;return o.button=0,o.which=o.buttons=1,this._copyProps(o,e,t._kbdProps),this._copyProps(o,i,t._ptProps),this._setOffsetAndLayerProps(o,s),o.dataTransfer=this._dataTransfer,s.dispatchEvent(o),o.defaultPrevented}return!1},t.prototype._closestDraggable=function(t){for(;t;t=t.parentElement)if(t.draggable)return t;return null},t}();n._instance=new n,n._THRESHOLD=5,n._OPACITY=.5,n._DBLCLICK=500,n._CTXMENU=900,n._ISPRESSHOLDMODE=!1,n._PRESSHOLDAWAIT=400,n._PRESSHOLDMARGIN=25,n._PRESSHOLDTHRESHOLD=0,n._rmvAtts="id,class,style,draggable".split(","),n._kbdProps="altKey,ctrlKey,metaKey,shiftKey".split(","),n._ptProps="pageX,pageY,clientX,clientY,screenX,screenY,offsetX,offsetY".split(","),t.DragDropTouch=n}(t||(t={}))}},e={};function n(s){var o=e[s];if(void 0!==o)return o.exports;var i=e[s]={exports:{}};return t[s](i,i.exports,n),i.exports}(()=>{"use strict";const t="TouchVTT",e="touch-vtt";let s;Hooks.once("init",(()=>{s=!globalThis.libWrapper||(globalThis.libWrapper.is_fallback??1)?class{static get is_fallback(){return!0}static register(t,e,n,s="MIXED"){const o=e.endsWith("#set"),i=(e=o?e.slice(0,-4):e).split("."),r=i.pop(),a=i.splice(0,1)[0],c=eval,l=i.reduce(((t,e)=>t[e]),globalThis[a]||c(a));let h=null;const u="OVERRIDE"===s?function(){return n.call(this,...arguments)}:function(){return n.call(this,h.bind(this),...arguments)},d=Object.getOwnPropertyDescriptor(l,r);if(null!=d){if(d.value)return h=l[r],void(l[r]=u);o?(h=d.set,d.set=u):(h=d.get,d.get=u),d.configurable=!0,Object.defineProperty(l,r,d)}else{if("function"!=typeof l[r])throw`libWrapper Shim: "${e}" does not exist or could not be found.`;h=l[r],l[r]=u}}}:globalThis.libWrapper}));const o="touch-vtt";function i(t,e,n="WRAPPER"){return s.register(o,t,e,n)}function r(t,e){return s.register(o,t,((t,...n)=>{if(e(...n))return t(...n)}),"MIXED")}function a(t,e=t.type,{trusted:n=!0,button:s=t.button,buttons:o=t.buttons}={},i=0){const r={clientX:(t.clientX||t.touches[0]?.clientX)+i,clientY:(t.clientY||t.touches[0]?.clientY)+i,screenX:(t.screenX||t.touches[0]?.screenX)+i,screenY:(t.screenY||t.touches[0]?.screenY)+i,ctrlKey:t.ctrlKey||!1,altKey:t.altKey||!1,shiftKey:t.shiftKey||!1,metaKey:t.metaKey||!1,button:s,buttons:o,relatedTarget:t.relatedTarget||null,region:t.region||null,detail:0,view:window,sourceCapabilities:t.sourceCapabilities,bubbles:!0,cancelable:!0,composed:!0},a={pointerId:t.pointerId,pointerType:"mouse",isPrimary:!0,...r};var c=t.nativeEvent?t.nativeEvent.target:t.target;let l;l=e.startsWith("mouse")?new MouseEvent(e,r):new PointerEvent(e,a),l.touchvttTrusted=n,c.dispatchEvent(l)}const c=new class{get zero(){return{x:0,y:0}}add(t,e){return{x:t.x+e.x,y:t.y+e.y}}subtract(t,e){return{x:t.x-e.x,y:t.y-e.y}}divideElements(t,e){return{x:t.x/e.x,y:t.y/e.y}}divideScalar(t,e){return{x:t.x/e,y:t.y/e}}distance(t,e){const n=this.subtract(t,e);return this.length(n)}distanceSquared(t,e){const n=this.subtract(t,e);return this.lengthSquared(n)}centerBetween(t,e){const n=this.subtract(t,e);return this.add(t,this.divideScalar(n,2))}centerOf(t,e,n){const s=[t,e,n],o=[this.distanceSquared(t,e)+this.distanceSquared(t,n),this.distanceSquared(e,t)+this.distanceSquared(e,n),this.distanceSquared(n,t)+this.distanceSquared(n,e)].reduce(((t,e,n)=>e<t.distance?{index:n,distance:e}:t),{distance:Number.MAX_VALUE,index:-1}).index,i=s.map(((t,e)=>e));i.splice(o,1);let r=s[o];for(const t of i){const e=this.subtract(s[o],s[t]);r=this.add(r,this.divideScalar(e,2))}return r}length(t){return Math.sqrt(t.x**2+t.y**2)}lengthSquared(t){return t.x**2+t.y**2}abs(t){return{x:Math.abs(t.x),y:Math.abs(t.y)}}isEqual(t,e){return t.x===e.x&&t.y===e.y}},l=function t(e){if((e=e&&e instanceof Object?e:"")instanceof Date)return new Date(e);if(e instanceof Array)return e.slice();if(e instanceof Object){const n=Object.create(e.constructor.prototype);for(const s in e)e.hasOwnProperty(s)&&(e[s]instanceof Object?n[s]=t(e[s]):n[s]=e[s]);return n}throw new Error("Unable to copy obj! Its type isn't supported.")},h=new class{get isGm(){return this.raw.isGM}get raw(){return game.user}},u=new class{isActive(t){const e=game.modules.get(t);return null!=e&&e.active}},d="LockView",g=new class{get raw(){return canvas}get zoom(){return this.raw.stage.scale.x}pan({x:t,y:e,zoom:n}){this.raw.pan({x:t,y:e,scale:n})}zoom(t){this.raw.pan({scale:t})}get worldTransform(){return this.raw.stage.transform.worldTransform}screenToWorld({x:t,y:e}){return this.worldTransform.applyInverse({x:t,y:e})}worldToScreen({x:t,y:e}){return this.worldTransform.apply({x:t,y:e})}worldToScreenLength(t){return this.worldTransform.apply({x:t,y:0}).x-this.worldTransform.apply({x:0,y:0}).x}getWorldTransformWith({zoom:t},{discrete:e=!0}={}){const n=l(this.worldTransform);return e&&(t=Math.round(100*t)/100),n.a=n.d=t,n}get gridSize(){return this.raw.grid.size}toRelativeCoordinates({x:t,y:e}){const n=this.worldSize;return{x:t/n.x,y:e/n.y}}get worldSize(){return{x:this.raw.scene.data.width,y:this.raw.scene.data.height}}get worldCenter(){const t=this.worldSize;return{x:t.x/2,y:t.y/2}}isZoomAllowed(){return!!h.isGm||!u.isActive(d)||!this.raw.scene.getFlag(d,"lockZoom")}isPanAllowed(){return!!h.isGm||!u.isActive(d)||!this.raw.scene.getFlag(d,"lockPan")}get ruler(){const t=canvas&&canvas.controls;return t&&t.ruler}},p=new class{get center(){return{x:window.innerWidth/2,y:window.innerHeight/2}}get size(){return{x:window.innerWidth,y:window.innerHeight}}toRelativeCoordinates({x:t,y:e}){const n=this.size;return{x:t/n.x,y:e/n.y}}},m=`${e}-bug_button_styles`,f="\n#controls ol.control-tools > li.scene-control, #controls ol.control-tools > li.control-tool {\n    width: 50px;\n    height: 50px;\n    line-height: 50px;\n    font-size: 28px;\n}\n#controls ol.control-tools {\n    left: 72px;\n}\n";function v(t){const e=document.getElementById(m);null!=e&&(e.innerHTML=t?f:"")}class T extends FormApplication{constructor(){super(),this.canvasTouchPointerEventsManager=null}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:`/modules/${e}/templates/gesture-calibration.hbs`,id:`${e}-gesture-calibration-form`,title:`${t} - Gesture Calibration`,resizable:!0,width:800,height:600})}getData(){return{zoomThresholdSetting:F(U),panThresholdSetting:F(z)}}async _updateObject(t,n){const s=expandObject(n);for(let t in s)game.settings.set(e,t,s[t])}async close(...t){super.close(...t),this.canvasTouchPointerEventsManager=null,game.settings.sheet.maximize()}activateListeners(t){super.activateListeners(t),Object.values(ui.windows).forEach((t=>t.minimize())),this.canvasTouchPointerEventsManager=et.init($("#touch-vtt-calibration").get(0));const e=t.find('input[name="zoomThreshold"]');e.change((()=>{this.canvasTouchPointerEventsManager.setForcedZoomThreshold(e.val())}));const n=t.find('input[name="panThreshold"]');n.change((()=>{this.canvasTouchPointerEventsManager.setForcedPanThreshold(n.val())}))}}const E="core",_="gestureMode",y="off",b="combined",w="split",S="directionalArrows",D="on",O="largeButtons",M="pauseButton",P="removeHover",C="easyTarget",I="off",R="single",L="multiple",A="measurementHud",k="off",x="right",H="left",G="canvasRightClickTimeout",N="canvasLongPressTimeout",U="zoomThreshold",z="panThreshold",W="debugMode";function F(t){let n;try{n=game.settings.get(e,t+"_override")}catch(t){n="override_off"}return"override_off"==n?game.settings.get(e,t):("Boolean"==game.settings.settings.get(e+"."+t).type.name&&(n="on"==n),n)}class X extends FormApplication{constructor(){super()}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:`/modules/${e}/templates/settings-override.hbs`,id:`${e}-settings-override-form`,title:`${t} - Settings Override`})}getData(){const t=[...game.settings.settings].filter((t=>t[0].startsWith(e)&&t[0].endsWith("_override")));return{settings:Object.fromEntries([...t].map((t=>{t[0]=t[0].split(".")[1];var n=game.settings.get(e,t[0]);return t[1].currentValue=n,t})))}}async _updateObject(t,n){const s=expandObject(n);for(let t in s)game.settings.set(e,t,s[t]);this.reloadConfirm()}async reloadConfirm(){await Dialog.confirm({title:game.i18n.localize("SETTINGS.ReloadPromptTitle"),content:`<p>${game.i18n.localize("SETTINGS.ReloadPromptBody")}</p>`})&&(game.user.isGM&&game.socket.emit("reload"),foundry.utils.debouncedReload())}activateListeners(t){super.activateListeners(t)}}const j=Object.freeze({left:0,right:2});class V{constructor({name:t,forwardingEvents:e=[],mouseButton:n=null,isFinal:s=!0}={}){this.name=t,this.forwardingEvents=e,this.mouseButton=n,this.isFinal=s}forwardsEvent(t){let e=t;return"object"==typeof t&&"string"==typeof t.type&&(e=t.type),-1!==this.forwardingEvents.indexOf(e)}}const Y=["pointerdown","pointermove","pointerup","pointercancel","touchstart","touchmove","touchend","touchcancel"],K=Object.freeze(new V({name:"primary-click",forwardingEvents:Y,mouseButton:j.left,isFinal:!1})),Z=Object.freeze(new V({name:"secondary-click",forwardingEvents:Y,mouseButton:j.right})),B=Object.freeze(new V({name:"zoom-pan"})),q=Object.freeze({PRIMARY_CLICK:K,SECONDARY_CLICK:Z,ZOOM_PAN_GESTURE:B});class J{constructor(t){this.touches={};const e=this.handleTouch.bind(this);for(const n of this.getListenerEvents())t instanceof HTMLElement?t.addEventListener(n,e,this.getEventListenerOptions()):document.addEventListener(n,(n=>{n.target.closest(t)&&e(n)}),this.getEventListenerOptions());this._gesturesEnabled=!0}preHandleAll(t){}preHandleTouch(t){}handleTouch(e){const n=this.touchIds.length;if(this.preHandleAll(e),this.isTouchPointerEvent(e)){if(this.preHandleTouch(e),this.shouldHandleEvent(e))switch(e.type){case"pointerdown":this.handleTouchStart(e);break;case"pointermove":this.handleTouchMove(e);break;case"pointerup":this.handleTouchEnd(e);break;case"pointercancel":this.handleEndAll(e);break;default:console.warn(`Unknown touch event type ${e.type}`)}n!=this.touchIds.length&&F(W)&&console.log(t+": touches changed: "+n+" -> "+this.touchIds.length)}}onStartMultiTouch(t){}onTouchAdded(t){}onTouchRemoved(t){}handleTouchStart(t){const e=this.touchIds.length;this.updateActiveTouch(t),e<=1&&this.touchIds.length>1&&this.onStartMultiTouch(t)}handleTouchEnd(t){this.cleanUpTouch(t)}handleEndAll(t){this.cleanUpAll()}handleTouchMove(t){this.updateActiveTouch(t)}updateActiveTouch(t){var e=t.pointerId;null!=this.touches[e]?this.touches[e].update(t,t):"pointerdown"==t.type&&1==t.buttons&&"pen"!=t.pointerType&&(this.touches[e]=new class{constructor(t,e,{context:n=q.PRIMARY_CLICK}={}){this.id=function(t){return null!=t.pointerId?t.pointerId:null!=t.touches&&t.touches.length>0?t.touches[0].identifier:null}(t),this.start=Object.freeze({x:e.clientX,y:e.clientY}),this.last=this.start,this.current=this.last,this.context=n,this.clientX=e.clientX,this.clientY=e.clientY,this.screenX=e.screenX,this.screenY=e.screenY,this.target=t.target,this.latestEvent=t,canvas.app&&(this.world=g.screenToWorld(this.current)),this.movementDistance=0,this.movement=c.zero}get identifier(){return this.id}update(t,e){this.latestEvent=t,this.last=this.current,this.current=Object.freeze({x:e.clientX,y:e.clientY}),this.movementDistance+=c.distance(this.last,this.current),this.movement=c.add(this.movement,c.subtract(this.current,this.last))}}(t,t),this.onTouchAdded(t))}cleanUpAll(){this.touches={},this.onTouchRemoved(event)}cleanUpTouch(t){delete this.touches[t.pointerId],this.onTouchRemoved(t)}getEventListenerOptions(){return{capture:!0,passive:!1}}getListenerEvents(){return["pointerdown","pointermove","pointerup","pointercancel"]}shouldHandleEvent(t){return t.isTrusted||t.touchvttTrusted}isTouchPointerEvent(t){return t instanceof PointerEvent&&["touch","pen"].includes(t.pointerType)}get touchIds(){return Object.keys(this.touches)}disableGestures(){this._gesturesEnabled=!1}enableGestures(){this._gesturesEnabled=!0}gesturesEnabled(){return this._gesturesEnabled}}J.init=function(t){return new J(t)};const Q=J;class tt extends Q{constructor(t){super(t),this._forcedZoomThreshold=null,this._forcedPanThreshold=null,this.GESTURE_STATUSES={NONE:0,WAITING:1,ACTIVE:2},this._zoomGesture={status:this.GESTURE_STATUSES.NONE,initiatingCoords:null,initiatingWorldCoords:null,activationCoords:null,activationWorldCoords:null},this._panGesture={status:this.GESTURE_STATUSES.NONE,initiatingCoords:null,activationCoords:null};const e=t=>(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),document.body.removeEventListener("pointerup",e),a(t,"pointerup"),!1);document.body.addEventListener("pointerdown",(n=>{if(n.isTrusted&&!n.pressure&&n.target===t)return n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation(),a(n,"pointermove"),a(n,"pointerdown"),document.body.addEventListener("pointerup",e),!1}),{capture:!0,passive:!1}),game.release.generation<12&&(Array("pointerdown","pointermove","pointerup","pointerleave","touchstart").forEach((e=>{window.addEventListener(e,(e=>{if(e.isTrusted&&(e instanceof TouchEvent||["touch","pen"].includes(e.pointerType))&&e.target===t)return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),["pointerdown","pointermove"].includes(e.type)&&a(e,"pointermove",{button:-1,buttons:0}),"touchstart"===e.type||"pointerleave"==e.type&&"pen"!=e.pointerType||function(t){let e={};for(let n in t)e[n]=t[n];e.pointerType="mouse";let n=new t.constructor(t.type,e);n.touchvttTrusted=!0,(t.nativeEvent?t.nativeEvent.target:t.target).dispatchEvent(n)}(e),!1}),{capture:!0,passive:!1})})),Array("pointerdown","pointerup").forEach((e=>{document.body.addEventListener(e,(e=>{(e.touchvttTrusted||e.isTrusted&&(e instanceof TouchEvent||["touch","pen"].includes(e.pointerType))&&e.target===t)&&canvas.activeLayer.placeables.forEach((t=>{const e=canvas.mousePosition;t.bounds.contains(e.x,e.y)?t.hover||(t._onHoverIn(new PIXI.FederatedEvent("pointerover"),{hoverOutOthers:!0}),t.mouseInteractionManager.state<MouseInteractionManager.INTERACTION_STATES.HOVER&&(t.mouseInteractionManager.state=MouseInteractionManager.INTERACTION_STATES.HOVER)):t.hover&&(t._onHoverOut(new PIXI.FederatedEvent("pointerout")),t.mouseInteractionManager.state=MouseInteractionManager.INTERACTION_STATES.NONE)}))}),!0)})))}onTouchAdded(t){if(this.touchIds.length>1){const e=new MouseEvent("contextmenu",{clientX:0,clientY:0,bubbles:!0,cancelable:!0,view:window,button:2});t.target.dispatchEvent(e),canvas.mouseInteractionManager.callback("clearTimeouts")}}onTouchRemoved(e){this.touchIds.length>0?(this.disableGestures(),F(W)&&console.log(t+": disabled gestures")):(this.enableGestures(),F(W)&&console.log(t+": enabled gestures")),canvas.mouseInteractionManager.callback("clearTimeouts"),this._zoomGesture={status:this.GESTURE_STATUSES.NONE,initiatingCoords:null,initiatingWorldCoords:null,activationCoords:null,activationWorldCoords:null},this._panGesture={status:this.GESTURE_STATUSES.NONE,initiatingCoords:null,activationCoords:null}}handleTouchMove(t){switch(this.updateActiveTouch(t),this.touchIds.length){case 2:this.gesturesEnabled()&&(this.useSplitGestures()?this.handleTwoFingerZoom():this.handleTwoFingerZoomAndPan());break;case 3:case 4:this.gesturesEnabled()&&this.handleMultiFingerPan()}}handleTwoFingerZoomAndPan(){this.handleTwoFingerZoom(),this.handleMultiFingerPan()}handleTwoFingerZoom(){if(!g.isZoomAllowed())return;const t=this.touchIds,e=this.touches[t[0]],n=this.touches[t[1]];this._zoomGesture.status==this.GESTURE_STATUSES.NONE&&(this._zoomGesture.initiatingCoords=[{...e.current},{...n.current}],this._zoomGesture.initiatingWorldCoords=[g.screenToWorld({...e.current}),g.screenToWorld({...n.current})],this._zoomGesture.status=this.GESTURE_STATUSES.WAITING);const s=c.distance(this._zoomGesture.initiatingCoords[0],this._zoomGesture.initiatingCoords[1]),o=c.distance(e.current,n.current);this._zoomGesture.status<this.GESTURE_STATUSES.ACTIVE&&Math.abs(o-s)>this.zoomThresholdFunction(this.getZoomThreshold())&&(this._zoomGesture.activationCoords=[{...e.current},{...n.current}],this._zoomGesture.activationWorldCoords=[g.screenToWorld({...e.current}),g.screenToWorld({...n.current})],this._zoomGesture.status=this.GESTURE_STATUSES.ACTIVE),this._zoomGesture.status==this.GESTURE_STATUSES.ACTIVE&&g.zoom(this.calcZoom())}calcZoom(){const t=this.touchIds,e=c.distance(this._zoomGesture.initiatingWorldCoords[0],this._zoomGesture.initiatingWorldCoords[1]),n=c.distance(this._zoomGesture.activationWorldCoords[0],this._zoomGesture.activationWorldCoords[1]);return c.distance(this.touches[t[0]].current,this.touches[t[1]].current)/((e+n)/2)}zoomThresholdFunction(t){return 0==t?1/0:t>80?-t/2+50:t>30?90-t:-10*t+360}setForcedZoomThreshold(t){this._forcedZoomThreshold=t}unsetForcedZoomThreshold(t){this._forcedZoomThreshold=null}getZoomThreshold(){return null!==this._forcedZoomThreshold?this._forcedZoomThreshold:F(U)}setForcedPanThreshold(t){this._forcedPanThreshold=t}unsetForcedPanThreshold(t){this._forcedPanThreshold=null}getPanThreshold(){return null!==this._forcedPanThreshold?this._forcedPanThreshold:F(z)}calcPanCorrection(t,e){const n=t.applyInverse(e.current);return c.subtract(n,e.world)}handleMultiFingerPan(){if(!g.isPanAllowed())return;const t=this.touchIds,e=g.worldTransform,n=this.touches[t[0]];this._panGesture.status==this.GESTURE_STATUSES.NONE&&(this._panGesture.initiatingCoords={...n.current},this._panGesture.status=this.GESTURE_STATUSES.WAITING);const s=c.distance(n.current,this._panGesture.initiatingCoords);if(this._panGesture.status<this.GESTURE_STATUSES.ACTIVE&&s>this.panThresholdFunction(this.getPanThreshold())&&(this._panGesture.status=this.GESTURE_STATUSES.ACTIVE),this._panGesture.status==this.GESTURE_STATUSES.ACTIVE){let n=this.calcPanCorrection(e,this.touches[t[0]]);const s=g.screenToWorld(p.center),o=c.subtract(s,n);g.pan({x:o.x,y:o.y})}}panThresholdFunction(t){return 0==t?1/0:t>50?-.8*t+80:t>20?-2*t+140:-10*t+300}useSplitGestures(){return F(_)===w}useNoGestures(){return F(_)===y}isTouchPointerEvent(t){return super.isTouchPointerEvent(t)||t.touchvttTrusted}gesturesEnabled(){return this._gesturesEnabled&&!this.useNoGestures()}}tt.init=function(t){return new tt(t)};const et=tt;class nt extends Q{constructor(t){super(t),this.selector=t,this.scrollStart=null}contextMenuCanceler(t){t.preventDefault(),t.stopPropagation()}onStartMultiTouch(t){a(t,"pointerup")}handleTouchMove(t){switch(this.updateActiveTouch(t),this.touchIds.length){case 2:case 3:case 4:this.gesturesEnabled()&&this.handleMultiFingerScroll(t)}}handleTouchEnd(t){this.cleanUpTouch(t),this.scrollStart=null,document.removeEventListener("contextmenu",this.contextMenuCanceler,!0)}handleMultiFingerScroll(){document.addEventListener("contextmenu",this.contextMenuCanceler,!0);const t=this.touchIds,e=this.touches[t[0]],n=this.findFirstScrollableParent(e.target);n&&(this.scrollStart||(this.scrollStart=n.scrollTop),n.scrollTop=this.scrollStart+e.start.y-e.current.y)}findFirstScrollableParent(t){let e=null;for(;!e&&t?.closest(this.selector);)t.scrollHeight>t.clientHeight+50&&(e=t),t=t.parentElement;return e}}nt.init=function(t){return new nt(t)};const st=nt;n(308);const ot=`${e}-draggable_apps_styles`;class it{constructor(){this.lastClickInfo={target:null,time:0,touch:!1},this.touchManager=st.init(".app:not(#touch-vtt-gesture-calibration-form), .application:not(#touch-vtt-gesture-calibration-form)"),this.lastPointerDownCoords=null;const t=(t=>{const e={x:t.clientX||t.touches?.[0]?.clientX,y:t.clientY||t.touches?.[0]?.clientY};if(c.distance(e,this.lastPointerDownCoords)<10)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1}).bind(this);document.addEventListener("pointerdown",(e=>{e.target.closest(".app, .application")&&(this.lastPointerDownCoords={x:e.clientX,y:e.clientY},Array("pointermove","touchmove","mousemove").forEach((e=>{document.getElementById("combat-tracker").addEventListener(e,t,!0)})))}),!0),document.addEventListener("pointerup",(e=>{e.target.closest(".app, .application")&&(this.lastPointerDownCoords=null,Array("pointermove","touchmove","mousemove").forEach((e=>{document.getElementById("combat-tracker").removeEventListener(e,t,!0)})))}),!0),document.body.addEventListener("dblclick",(t=>{const e=!!t.target.closest(".app, .application");if(t.isTrusted&&e&&this.lastClickInfo.touch)return t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),!1}),!0),document.body.addEventListener("click",(t=>{t.target.closest(".app, .application")&&this.manageTouchDblClick.call(this,t)})),i("DragDrop.prototype._handleDragStart",(function(t,e){if(e.dataTransfer.items)return t.call(this,e);this.callback(e,"dragstart"),Object.keys(e.dataTransfer._data).length&&e.stopPropagation()}),"MIXED")}manageTouchDblClick(t){const e=["touch","pen"].includes(t.pointerType);e&&Date.now()-this.lastClickInfo.time<500&&t.target==this.lastClickInfo.target&&(a(t,"dblclick"),this.lastClickInfo={target:null,time:0,touch:e}),this.lastClickInfo={target:t.target,time:Date.now(),touch:e}}fixDirectoryScrolling(t,e){const n=t.element.find(".directory-list");n.length>0&&(e?n.find('li[draggable="true"].directory-item').each((function(t,e){e.draggable=!1;let n=document.createElement("i");n.className="handlebar fas fa-grip-vertical",n.addEventListener("pointerdown",(t=>{e.draggable=!0}),!0),n.addEventListener("pointerup",(t=>{["touch","pen"].includes(t.pointerType)&&(e.draggable=!1)}),!0),e.classList.contains("folder")||e.classList.contains("folder-like")?e.getElementsByTagName("header")[0].prepend(n):e.prepend(n)})):(n.find(".directory-item .handlebar").remove(),n.find('li[draggable="false"].directory-item').each((function(t,e){e.draggable=!0}))))}}it.init=function(){return function(){const t=document.createElement("style");t.setAttribute("id",ot),t.innerHTML="\n.app, .application {\n  touch-action: none;\n}\n\n.app .window-header, .application .window-header, .app .window-title, .application .window-title {\n  touch-action: none;\n}\n\n.directory-item .handlebar {\n  display: none;\n  flex: 0 0 20px;\n  align-self: center;\n  font-size: 1.6em;\n  z-index: 10;\n}\n\n.directory-item.document .handlebar {\n  height: var(--sidebar-item-height);\n  padding: 14px 0 0 4px;\n}\n\n.directory-item.folder .handlebar {\n  line-height: 24px;\n  margin: 0 4px 0 0;\n}\n\n.directory-item.compendium .handlebar {\n  position: absolute;\n  left: 6px;\n}\n\nbody.touchvtt-using-touch .directory-item.compendium {\n  flex-direction: row;\n}\n\nbody.touchvtt-using-touch .directory-item.compendium .compendium-banner {\n  pointer-events: none;\n}\n\nbody.touchvtt-using-touch .directory-item .handlebar {\n  display: flex;\n}\n",document.head.append(t)}(),new it};const rt=it,at="erase";class ct extends Application{constructor({touchPointerEventsManager:t,templateManager:e}){super(),this._touchPointerEventsManager=t,this._templateManager=e,this._worldPosition=null,this._screenPosition={},this._currentTemplate=null}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"touch-measured-template-hud",template:`/modules/${e}/templates/measured-template-hud.hbs`,popOut:!1,width:200,height:100,left:150,top:80,scale:1,minimizable:!1,resizable:!1,dragDrop:[],tabs:[],scrollY:[]})}getData(...t){const e=super.getData(...t);return e.id=this.options.id,e.top=this._screenPosition.top,e.left=this._screenPosition.left,e.offsetX=this.calcOffsetX(),e.showRotate=!0,e.showConfirm=!0,e.showCancel=!0,e}activateListeners(t){t.find(".rotate").on("pointerdown",(()=>{this._currentTemplate.document.updateSource({direction:this._currentTemplate.document.direction+15}),this._currentTemplate.refresh()})),t.find(".confirm").on("pointerdown",(()=>{this._templateManager.toggleMeasuredTemplateTouchManagementListeners(!1),this._templateManager._touchMode=!1,canvas.app.view.dispatchEvent(new PointerEvent("pointerdown",{pointerType:"mouse",isPrimary:!0,clientX:this._screenPosition.left,clientY:this._screenPosition.top,button:0,buttons:1})),canvas.app.view.dispatchEvent(new PointerEvent("pointerup",{pointerType:"mouse",isPrimary:!0,clientX:this._screenPosition.left,clientY:this._screenPosition.top,button:0,buttons:1})),canvas.hud.touchMeasuredTemplate.clear()})),t.find(".cancel").on("pointerdown",(()=>{this._templateManager.toggleMeasuredTemplateTouchManagementListeners(!1),this._templateManager._touchMode=!1,canvas.app.view.dispatchEvent(new MouseEvent("contextmenu",{clientX:0,clientY:0,bubbles:!0,cancelable:!0,view:window,button:2})),canvas.hud.touchMeasuredTemplate.clear()}))}async show(t){this._currentTemplate=t;const e={x:t.document.x,y:t.document.y};if(this._templateManager._touchMode){this._worldPosition=e;const t=g.worldToScreen(e);this.setScreenPosition({left:t.x,top:t.y});const n=this.constructor.RENDER_STATES;await this.render(this._state<=n.NONE),this._touchPointerEventsManager.disableGestures()}}clear(){const t=this.constructor.RENDER_STATES;this._state<=t.NONE||(this._state=t.CLOSING,this.element.hide(),this._state=t.NONE,this._touchPointerEventsManager.enableGestures())}setScreenPosition({top:t,left:e}){this._screenPosition={top:t,left:e}}calcOffsetX(){const t=.75*g.worldToScreenLength(g.gridSize);return F(A)===H?`calc(-100% - ${t}px)`:`${t}px`}}class lt{constructor(){this._touchMode=!1,this._touchEventReplacer=this.touchEventReplacer.bind(this)}initMeasuredTemplateHud(t){null==canvas.hud.touchMeasuredTemplate&&(canvas.hud.touchMeasuredTemplate=new ct({touchPointerEventsManager:t,templateManager:this}),i("MeasuredTemplate.prototype._applyRenderFlags",(function(t,e){return e.refreshPosition&&canvas.hud.touchMeasuredTemplate.show(this),t.call(this,e)})))}touchEventReplacer(t){if(t.isTrusted||t.touchvttTrusted){if(!(t instanceof TouchEvent||t instanceof PointerEvent&&(["touch","pen"].includes(t.pointerType)||t.touchvttTrusted)))return this._touchMode=!1,this.toggleMeasuredTemplateTouchManagementListeners(!1);this._touchMode=!0}return!this._touchMode||!t.isTrusted&&!t.touchvttTrusted||"CANVAS"!=t.target.tagName||(t.preventDefault(),t.stopPropagation(),t instanceof PointerEvent&&a(t,"pointermove",{trusted:!1,button:-1,buttons:0}),!1)}toggleMeasuredTemplateTouchManagementListeners(t=!0){["pointerdown","pointerup","pointermove","pointercancel","touchstart","touchmove","touchend"].forEach(t?t=>{window.document.addEventListener(t,this._touchEventReplacer,!0)}:t=>{window.document.removeEventListener(t,this._touchEventReplacer,!0)})}onTemplatePreviewCreated(t){this.isPremade(t)&&this.toggleMeasuredTemplateTouchManagementListeners(!0)}initMeasuredTemplateManagement(){const t=()=>game.activeTool===at,e=()=>!t()&&!this._touchMode;r("TemplateLayer.prototype._onDragLeftStart",e),r("TemplateLayer.prototype._onDragLeftMove",e),r("TemplateLayer.prototype._onDragLeftDrop",e),r("TemplateLayer.prototype._onDragLeftCancel",e),i("MeasuredTemplate.prototype._onClickLeft",(function(e,...n){t()?(this.document.delete(),game.release.generation<12&&setTimeout((()=>{canvas.app.view.dispatchEvent(new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,button:2}))}),0)):e(...n)}),"MIXED")}isPremade(t){const e=game.release.generation<12?canvas.grid.grid.options.dimensions.distance:canvas.grid.distance;return!t.id&&t.document.distance>e}}lt.init=function(){return new lt};let ht=!1;let ut=!0;function dt(){return F(C)}function gt(t,e){const n=game.i18n.localize(`TOUCHVTT.Rotate${e}`),s=$(`<div class="control-icon directional-arrow directional-arrow-${e}" data-action="rotate-${e}" title="${n}">\n      <i class="fas fa-chevron-up"></i>\n    </div>`);s.on("click",(()=>{const t=pt();var n;null!=(n=t)&&"function"==typeof n._canDrag&&n._canDrag()&&t.rotate((e+180)%360)})),t.prepend(s)}function pt(){return canvas&&canvas.hud&&canvas.hud.token&&canvas.hud.token.object}class mt extends Application{constructor({touchPointerEventsManager:t}){super(),this._touchPointerEventsManager=t,this._worldPosition=null,this._screenPosition={}}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"touch-measurement-hud",template:`/modules/${e}/templates/measurement-hud.hbs`,popOut:!1,width:200,height:100,left:150,top:80,scale:1,minimizable:!1,resizable:!1,dragDrop:[],tabs:[],scrollY:[]})}getData(...t){const e=super.getData(...t);return e.id=this.options.id,e.top=this._screenPosition.top,e.left=this._screenPosition.left,e.offsetX=this.calcOffsetX(),e.showRuler=!c.isEqual(this._worldPosition??{},this.lastWaypoint),e.showMove=this.canMoveToken(),e}activateListeners(t){t.find(".waypoint").on("pointerdown",(()=>{const t=g.ruler;null!=t&&"function"==typeof t._addWaypoint&&(t._addWaypoint(this._worldPosition),this.render())})),t.find(".move").on("pointerdown",(()=>{const t=g.ruler;null!=t&&"function"==typeof t.moveToken&&((t.token||t._getMovementToken()).document.locked=!1,t.moveToken(),this.render())}))}async show(t){this._worldPosition=t;const e=g.worldToScreen(t);this.setScreenPosition({left:e.x,top:e.y});const n=this.constructor.RENDER_STATES;await this.render(this._state<=n.NONE),this._touchPointerEventsManager.disableGestures()}clear(){const t=this.constructor.RENDER_STATES;this._state<=t.NONE||(this._state=t.CLOSING,this.element.hide(),this._state=t.NONE,this._touchPointerEventsManager.enableGestures())}setScreenPosition({top:t,left:e}){this._screenPosition={top:t,left:e}}get lastWaypoint(){const t=g.ruler;return(t&&t.waypoints[t.waypoints.length-1])??{}}canMoveToken(){const t=g.ruler;return!(null==t||game.paused&&!game.user.isGM||!t.visible||!t.destination||null==t._getMovementToken(t.origin))}calcOffsetX(){const t=.75*g.worldToScreenLength(g.gridSize);return vt()===H?`calc(-100% - ${t}px)`:`${t}px`}}function ft(t){return g.ruler===t}function vt(){return F(A)}class Tt{constructor(e,n,s={},o={},i={}){this.object=e,this.layer=n,this.permissions=s,this.callbacks=o,this.options=i,F(W)?(this._state=this.states.NONE,Object.defineProperty(this,"state",{get(){return this._state},set(e){console.log(t+": "+this.object.constructor.name,this._state+" -> "+e+" ("+(new Error).stack?.split("\n")[2]?.trim().split(" ")[1]+")"),this._state=e}})):this.state=this.states.NONE,this.interactionData={},this.dragTime=0,this.lcTime=0,this.rcTime=0,this._dragRight=!1,this.controlIcon=this.options.target?this.object[this.options.target]:void 0;const r=this.options.application??canvas.app;this.viewId=r.view.id}#t={};static INTERACTION_STATES={NONE:0,HOVER:1,CLICKED:2,DRAG:3,DROP:4};static _HANDLER_OUTCOME={SKIPPED:-2,DISALLOWED:-1,REFUSED:1,ACCEPTED:2};static LONG_PRESS_DURATION_MS=99999999;static longPressTimeout=null;get target(){return this.options.target?this.object[this.options.target]:this.object}get isDragging(){return this.state>=this.states.DRAG}activate(){return this.state=this.states.NONE,this.target.removeAllListeners(),this.#t={mouseover:this.#e.bind(this),mouseout:this.#n.bind(this),mousedown:this.#s.bind(this),rightdown:this.#o.bind(this),mousemove:this.#i.bind(this),mouseup:this.#r.bind(this),contextmenu:this.#a.bind(this)},this.#c(),this.target.eventMode="static",this}can(t,e){const n=this.permissions[t];return"boolean"==typeof n?n:!(n instanceof Function)||n.call(this.object,game.user,e)}callback(t,e,...n){const s=this.callbacks[t];return!(s instanceof Function)||(this.#l(e),s.call(this.object,e,...n)??!0)}get states(){return this.constructor.INTERACTION_STATES}get handlerOutcomes(){return this.constructor._HANDLER_OUTCOME}#c(){this.target.off("pointerover",this.#t.mouseover).on("pointerover",this.#t.mouseover),this.target.off("pointerout",this.#t.mouseout).on("pointerout",this.#t.mouseout)}#h(){this.#u(),this.target.on("pointerdown",this.#t.mousedown),this.target.on("pointerup",this.#t.mouseup),this.target.on("pointerupoutside",this.#t.mouseup),this.target.on("rightdown",this.#t.rightdown),this.target.on("rightup",this.#t.mouseup),this.target.on("rightupoutside",this.#t.mouseup)}#u(){this.target.off("pointerdown",this.#t.mousedown),this.target.off("pointerup",this.#t.mouseup),this.target.off("pointerupoutside",this.#t.mouseup),this.target.off("rightdown",this.#t.rightdown),this.target.off("rightup",this.#t.mouseup),this.target.off("rightupoutside",this.#t.mouseup)}#d(){this.#g(),this.layer.on("pointermove",this.#t.mousemove),this._dragRight||canvas.app.view.addEventListener("contextmenu",this.#t.contextmenu,{capture:!0})}#g(t){this.layer.off("pointermove",this.#t.mousemove),canvas.app.view.removeEventListener("contextmenu",this.#t.contextmenu,{capture:!0})}#e(t){const e="hoverIn";return this.state!==this.states.NONE||t.nativeEvent.target.id!==this.viewId?this.#p(e,t,this.handlerOutcomes.SKIPPED):this.can(e,t)?this.callback(e,t)?(this.state=Math.max(this.state||0,this.states.HOVER),this.#h(),this.#p(e,t)):this.#p(e,t,this.handlerOutcomes.REFUSED):this.#p(e,t,this.handlerOutcomes.DISALLOWED)}#n(t){if("touch"===t.pointerType)return;const e="hoverOut";return this.state!==this.states.HOVER||t.nativeEvent.target.id!==this.viewId?this.#p(e,t,this.handlerOutcomes.SKIPPED):this.can(e,t)?!1===this.callback(e,t)?this.#p(e,t,this.handlerOutcomes.REFUSED):(this.state===this.states.HOVER&&(this.state=this.states.NONE,this.#u()),this.#p(e,t)):this.#p(e,t,this.handlerOutcomes.DISALLOWED)}#s(t){if(0!==t.button)return;if(![this.states.HOVER,this.states.CLICKED,this.states.DRAG].includes(this.state))return;const e=Date.now(),n=e-this.lcTime<=250;return this.lcTime=e,this.interactionData.origin=t.getLocalPosition(this.layer),n||(clearTimeout(this.constructor.longPressTimeout),this.constructor.longPressTimeout=setTimeout((()=>{this.#m(t,this.interactionData.origin)}),MouseInteractionManager.LONG_PRESS_DURATION_MS)),n&&this.can("clickLeft2",t)?this.#f(t):this.#v(t)}#v(t){const e="clickLeft";return this.can(e,t)?(this._dragRight=!1,!1===this.callback(e,t)?this.#p(e,t,this.handlerOutcomes.REFUSED):(this.state===this.states.HOVER&&(this.state=this.states.CLICKED),canvas.currentMouseManager=this,this.state<this.states.DRAG&&this.can("dragStart",t)&&this.#d(),this.#p(e,t))):this.#p(e,t,this.handlerOutcomes.DISALLOWED)}#f(t){const e="clickLeft2";return!1===this.callback(e,t)?this.#p(e,t,this.handlerOutcomes.REFUSED):this.#p(e,t)}#m(t,e){const n="longPress";return!1===this.callback(n,t,e)?this.#p(n,t,this.handlerOutcomes.REFUSED):this.#p(n,t)}#o(t){if(![this.states.HOVER,this.states.CLICKED,this.states.DRAG].includes(this.state))return;if(2!==t.button)return;const e=Date.now(),n=e-this.rcTime<=250;return this.rcTime=e,this.interactionData.origin=t.getLocalPosition(this.layer),n&&this.can("clickRight2",t)?this.#T(t):this.#E(t)}#E(t){const e="clickRight";return this.can(e,t)?(this._dragRight=!0,!1===this.callback(e,t)?this.#p(e,t,this.handlerOutcomes.REFUSED):(this.state===this.states.HOVER&&(this.state=this.states.CLICKED),canvas.currentMouseManager=this,this.state<this.states.DRAG&&this.can("dragRight",t)&&this.#d(),this.#p(e,t))):this.#p(e,t,this.handlerOutcomes.DISALLOWED)}#T(t){const e="clickRight2";return!1===this.callback(e,t)?this.#p(e,t,this.handlerOutcomes.REFUSED):this.#p(e,t)}#i(t){if(![this.states.CLICKED,this.states.DRAG].includes(this.state))return;const e=Date.now();if(e-this.dragTime<canvas.app.ticker.elapsedMS)return;this.dragTime=e;const n=this.interactionData;if(n.destination=t.getLocalPosition(this.layer),void 0===n.origin&&(n.origin=(new PIXI.Point).copyFrom(n.destination)),this.state!==this.states.CLICKED)return this.#_(t);{const e=n.destination.x-n.origin.x,s=n.destination.y-n.origin.y;if(Math.hypot(e,s)>=(this.options.dragResistance||canvas.dimensions.size/4))return this.#y(t)}}#y(t){clearTimeout(this.constructor.longPressTimeout);const e=this._dragRight?"dragRightStart":"dragLeftStart";if(!this.can(e,t))return this.#p(e,t,this.handlerOutcomes.DISALLOWED);const n=this.callback(e,t);return n&&(this.state=this.states.DRAG),this.#p(e,t,n?this.handlerOutcomes.ACCEPTED:this.handlerOutcomes.REFUSED)}#_(t){clearTimeout(this.constructor.longPressTimeout);const e=this._dragRight?"dragRightMove":"dragLeftMove";if(!this.can(e,t))return this.#p(e,t,this.handlerOutcomes.DISALLOWED);const n=this.callback(e,t);return n&&(this.state=this.states.DRAG),this.#p(e,t,n?this.handlerOutcomes.ACCEPTED:this.handlerOutcomes.REFUSED)}#r(e){if(F(W)&&console.log(t+": "+this.object.constructor.name,"handleMouseUp from state "+this.state+": ",e.target.constructor.name,e.constructor.name,e.type,e.pointerType,e.nativeEvent?.constructor.name,e.nativeEvent?.target.tagName,e.nativeEvent?.type,e.nativeEvent?.pointerType,"trust:"+e.nativeEvent?.isTrusted+","+e.nativeEvent?.touchvttTrusted),"walls"==ui.controls.activeControl&&void 0!==window.Touch&&e.nativeEvent instanceof Touch)return!0;this.callback("clearTimeouts"),clearTimeout(this.constructor.longPressTimeout),this.state===this.states.HOVER&&"touch"===e.pointerType&&(this.state=this.states.DRAG);const n=this.state;if(this.interactionData.destination=e.getLocalPosition(this.layer),this.state===this.states.CLICKED&&!e.defaultPrevented&&e.target!==this.object&&e.target?.parent!==this.object&&(e.stopPropagation(),this.state=this.states.HOVER,this.#u(),this.#n(e)),this.state>=this.states.DRAG){if(e.stopPropagation(),e.type.startsWith("right")&&!this._dragRight)return;this.#b(e)}return e.defaultPrevented?(this.state=n,this.#p("mouseUp",e,this.handlerOutcomes.SKIPPED)):this.#a(e)}#b(t){const e=this._dragRight?"dragRightDrop":"dragLeftDrop";return this.can(e,t)?!1===this.callback(e,t)?this.#p(e,t,this.handlerOutcomes.DISALLOWED):(this.state=this.states.DROP,this.#p(e,t)):this.#p(e,t,this.handlerOutcomes.DISALLOWED)}#a(t){this.cancel(t)}handleEvent(t){switch(t.type){case"pointerover":this.#e(t);break;case"pointerout":this.#n(t);break;case"pointerup":this.#r(t);break;case"pointerdown":2===t.button?this.#o(t):this.#s(t);break;default:return!1}return!0}cancel(t){const e=this._dragRight?"dragRightCancel":"dragLeftCancel",n=this.state;return n<=this.states.HOVER?this.#p(e,t,this.handlerOutcomes.SKIPPED):n>=this.states.DRAG&&!1===this.callback(e,t)?this.#p(e,t,this.handlerOutcomes.REFUSED):t.defaultPrevented?(this.state=this.states.DRAG,this.#p(e,t,this.handlerOutcomes.SKIPPED)):(this.interactionData={},this.state=this.states.HOVER,canvas.currentMouseManager=null,this.#g(),this.#p(e,t))}#p(t,e,n=this.handlerOutcomes.ACCEPTED){if(CONFIG.debug.mouseInteraction){const s=this.object.constructor.name,o=e.target?.constructor.name,{eventPhase:i,type:r,button:a}=e;let c=`${s} | ${t} | state:${Object.keys(this.states)[this.state.toString()]} | target:${o} | phase:${i} | type:${r} | btn:${a} | skipped:${n<=-2} | allowed:${n>-1} | handled:${n>1}`;console.debug(c)}}reset({interactionData:t=!0,state:e=!0}={}){CONFIG.debug.mouseInteraction&&console.debug(`${this.object.constructor.name} | Reset | interactionData:${t} | state:${e}`),t&&(this.interactionData={}),e&&(this.state=MouseInteractionManager.INTERACTION_STATES.NONE)}#l(t){this.interactionData.object=this.object,t.interactionData=this.interactionData;for(const e of Object.keys(this.interactionData))t.hasOwnProperty(e)||Object.defineProperty(t,e,{get(){const t=`event.data.${e} is deprecated in favor of event.interactionData.${e}.`;return foundry.utils.logCompatibilityWarning(t,{since:11,until:12}),this.interactionData[e]},set(t){const n=`event.data.${e} is deprecated in favor of event.interactionData.${e}.`;foundry.utils.logCompatibilityWarning(n,{since:11,until:12}),this.interactionData[e]=t}})}}window.TouchEvent||(window.TouchEvent=function(){},window.TouchEvent.prototype={});let Et=null,_t=null,yt=null;const bt=lt.init();let wt=null,St=!1;function Dt(t){if(St=t,t){if(MouseInteractionManager.LONG_PRESS_DURATION_MS=99999999,document.body.classList.add("touchvtt-using-touch"),F(P))try{for(let t of document.styleSheets)if(t.cssRules)for(var e=t.cssRules.length-1;e>=0;e--){let n=t.cssRules[e].selectorText;n&&n.match(":hover")&&!n.match(".control-tools")&&t.deleteRule(e)}}catch(t){}}else MouseInteractionManager.LONG_PRESS_DURATION_MS=500,document.body.classList.remove("touchvtt-using-touch")}console.log(`${t} booting ...`),Hooks.on("getSceneControlButtons",(t=>{F(E)&&(function(t){const e=t.find((t=>"measure"===t.name));if(null!=e){const t=e.tools.findIndex((t=>"clear"===t.name));-1!==t&&e.tools.splice(t,0,{name:at,title:"TOUCHVTT.Erase",icon:"fas fa-eraser"})}}(t),function(t){const e=t.find((t=>"walls"===t.name));null!=e&&Array.isArray(e.tools)&&e.tools.push({name:"tile",title:"TOUCHVTT.ToggleWallChain",icon:"fas fa-link",toggle:!0,active:ht,onClick:t=>ht=t},{name:"undo",title:"TOUCHVTT.UndoWall",icon:"fas fa-undo",button:!0,onClick:()=>canvas.walls.undoHistory()},{name:"Delete",title:"TOUCHVTT.DeleteWall",icon:"fas fa-eraser",button:!0,onClick:()=>canvas.walls._onDeleteKey()})}(t),function(t){const e=t.find((t=>"drawings"===t.name));null!=e&&Array.isArray(e.tools)&&e.tools.push({name:"Delete",title:"TOUCHVTT.DeleteDrawing",icon:"fas fa-eraser",button:!0,onClick:()=>canvas.drawings._onDeleteKey()})}(t),function(t){const e=t.find((t=>"token"===t.name));null!=e&&e.tools.push({name:"snap",title:"TOUCHVTT.SnapToGrid",icon:"fas fa-border-all",toggle:!0,active:ut,onClick:t=>ut=t})}(t),function(t){if(game.user.isGM){const e=t.find((t=>"token"===t.name));if(null==e||!Array.isArray(e.tools))return;e.tools.push({name:"Delete",title:"TOUCHVTT.DeleteToken",icon:"fas fa-eraser",button:!0,onClick:()=>canvas.tokens._onDeleteKey()})}}(t))})),Hooks.on("renderSceneControls",(t=>{F(E)&&function(){$("#touch-vtt-controls").remove();const t=$("<div>").attr("id","touch-vtt-controls");t.toggleClass("hidden",!F(M)),game.user.isGM&&$("<button>").append($("<i>").addClass("fas").addClass(game.paused?"fa-play":"fa-pause")).attr("id","touch-vtt-togglepause").click((function(){game.paused?$(this).find("i").removeClass("fa-play").addClass("fa-pause"):$(this).find("i").removeClass("fa-pause").addClass("fa-play"),game.togglePause(!game.paused,!0)})).appendTo(t),$("#controls").prepend(t)}()})),Hooks.once("init",(()=>{game.settings.register(e,E+"_override",{name:"Core Functionality",hint:"Caution: disabling this option will remove all TouchVTT functionality, and other options will be ignored",scope:"world",config:!1,type:String,choices:{on:"On",off:"Off",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,_+"_override",{name:"Zoom / Pan Gestures",hint:"Select the gesture to use for zooming & panning the game canvas",scope:"world",config:!1,type:String,choices:{[b]:"Zoom & Pan with 2 fingers",[w]:"Zoom with 2 fingers, pan with 3 fingers",[y]:"No zoom or pan gestures",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,S+"_override",{name:"Direction arrows in Token HUD",hint:"Enables / disables the addition of arrow buttons used to rotate a token in the token's right-click menu",scope:"world",config:!1,type:String,choices:{[D]:"On",off:"Off",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,C+"_override",{name:"Targeting behavior",hint:"Controls if and how unowned tokens can be targeted via the touch interface",scope:"world",config:!1,type:String,choices:{[I]:"Disabled",[R]:"Allow single target",[L]:"Allow multiple targets",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,A+"_override",{name:"Measurement HUD",hint:"Shows a UI while measuring distance with the ruler, allowing you to set waypoints or move your token",scope:"world",config:!1,type:String,choices:{[k]:"Disabled",[x]:"Show right",[H]:"Show left",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,O+"_override",{name:"Enlarge buttons in on-screen UI",hint:"Increases the size of menu bar buttons to make them easier to use with touch controls",scope:"world",config:!1,type:String,choices:{on:"On",off:"Off",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,M+"_override",{name:"Show a play/pause button",hint:"Adds a play/pause button to the UI controls",scope:"world",config:!1,type:String,choices:{on:"On",off:"Off",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,P+"_override",{name:"Remove hover effects",hint:"Disable hover effects on touch devices",scope:"world",config:!1,type:String,choices:{on:"On",off:"Off",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,G+"_override",{name:"Canvas right-click timer (ms)",hint:"How long a touch on the canvas takes to become a right click",scope:"world",config:!1,type:String,choices:{on:"On",off:"Off",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,N+"_override",{name:"Canvas ping timer (ms)",hint:"How long a touch on the canvas takes to become a ping",scope:"world",config:!1,type:String,choices:{on:"On",off:"Off",override_off:"Don't override"},default:"override_off"}),game.settings.register(e,E,{name:"Core Functionality"+("override_off"==game.settings.get(e,E+"_override")?"":" *"),hint:"Caution: disabling this option will remove all TouchVTT functionality, and other options will be ignored",scope:"client",config:!0,requiresReload:!0,type:Boolean,default:!0}),game.settings.register(e,_,{name:"Zoom / Pan Gestures"+("override_off"==game.settings.get(e,_+"_override")?"":" *"),hint:"Select the gesture to use for zooming & panning the game canvas",scope:"client",config:!0,type:String,choices:{[b]:"Zoom & Pan with 2 fingers",[w]:"Zoom with 2 fingers, pan with 3 fingers",[y]:"No zoom or pan gestures"},default:b}),game.settings.register(e,U,{name:"Zoom Sensitivity",hint:"Sensitivity of the zoom gesture (if enabled)",scope:"client",config:!1,type:Number,range:{min:0,max:100,step:1},default:100}),game.settings.register(e,z,{name:"Pan Sensitivity",hint:"Sensitivity of the pan gesture (if enabled)",scope:"client",config:!1,type:Number,range:{min:0,max:100,step:1},default:100}),game.settings.register(e,S,{name:"Direction arrows in Token HUD"+("override_off"==game.settings.get(e,S+"_override")?"":" *"),hint:"Enables / disables the addition of arrow buttons used to rotate a token in the token's right-click menu",scope:"client",config:!0,type:String,choices:{[D]:"On",off:"Off"},default:D}),game.settings.register(e,C,{name:"Targeting behavior"+("override_off"==game.settings.get(e,C+"_override")?"":" *"),hint:"Controls if and how unowned tokens can be targeted via the touch interface",scope:"client",config:!0,type:String,choices:{[I]:"Disabled",[R]:"Allow single target",[L]:"Allow multiple targets"},default:R}),game.settings.register(e,A,{name:"Measurement HUD"+("override_off"==game.settings.get(e,A+"_override")?"":" *"),hint:"Shows a UI while measuring distance with the ruler, allowing you to set waypoints or move your token",scope:"client",config:!0,type:String,choices:{[k]:"Disabled",[x]:"Show right",[H]:"Show left"},default:x}),game.settings.register(e,O,{name:"Enlarge buttons in on-screen UI"+("override_off"==game.settings.get(e,O+"_override")?"":" *"),hint:"Increases the size of menu bar buttons to make them easier to use with touch controls",scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>v(t)}),game.settings.register(e,M,{name:"Show a play/pause button"+("override_off"==game.settings.get(e,M+"_override")?"":" *"),hint:"Adds a play/pause button to the UI controls",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>function(t){$("#touch-vtt-controls").toggleClass("hidden",!t)}(t)}),game.settings.register(e,P,{name:"Remove hover effects"+("override_off"==game.settings.get(e,P+"_override")?"":" *"),hint:"Disable hover effects on touch devices",scope:"client",config:!0,requiresReload:!0,type:Boolean,default:!1}),game.settings.register(e,G,{name:"Canvas right-click timer (ms)"+("override_off"==game.settings.get(e,G+"_override")?"":" *"),hint:"How long a touch on the canvas takes to become a right click",scope:"client",config:!0,type:Number,range:{min:100,step:50,max:3e3},default:400}),game.settings.register(e,N,{name:"Canvas ping timer (ms)"+("override_off"==game.settings.get(e,N+"_override")?"":" *"),hint:"How long a touch on the canvas takes to become a ping",scope:"client",config:!0,type:Number,range:{min:100,step:50,max:3e3},default:1e3}),game.settings.register(e,W,{name:"Enable Debug Mode",hint:"Sends additional log messages to the developer console",scope:"client",config:!0,requiresReload:!0,type:Boolean,default:!1}),game.settings.registerMenu(e,"SettingsOverrideMenu",{name:"Client Settings Overrides",label:"Configure Overrides",hint:"Configure which client settings are forced by the GM.",icon:"fas fa-bars",type:X,restricted:!0}),game.settings.registerMenu(e,"GestureCalibrationMenu",{name:"Gesture Sensitivity Calibration",label:"Calibrate Touch Gestures",hint:"Gesture detection can be influenced by your display size and resolution. Use this tool to calibrate if you have issues with sensitivity.",icon:"fas fa-wrench",type:T,restricted:!1}),Hooks.on("renderSettingsConfig",((t,n,s)=>{var o=s.categories.find((t=>t.id==e)).settings;let i=!1;o.forEach((t=>{let e=t.name.endsWith("*");n.find(`[name='${t.id}']`).prop("disabled",e),i|=e})),i&&n.find(`[data-tab='${e}'] h2`).after($("<small>").html("Some settings, indicated with an asterisk (*), are being overridden by the GM. The values selected here might not be accurate."))})),F(E)?(["renderDocumentDirectory","renderDirectoryApplication","changeSidebarTab"].forEach((t=>{Hooks.on(t,(function(t){wt.fixDirectoryScrolling(t,St)}))})),function(){const t=document.createElement("style");t.setAttribute("id",m),document.head.append(t)}(),v(F(O)||!1),"function"==typeof TokenHUD&&"object"==typeof TokenHUD.prototype&&"function"==typeof TokenHUD.prototype.activateListeners&&i("TokenHUD.prototype.activateListeners",(function(t,e,...n){const s=t(e,...n);return F(S)!==D||pt()?.document?.lockRotation||function(t){const e=t.find(".col.left"),n=t.find(".col.middle"),s=t.find(".col.right");gt(n,0),gt(s,45),gt(s,90),gt(s,135),gt(n,180),gt(e,225),gt(e,270),gt(e,315)}(e),s})),bt.initMeasuredTemplateManagement(),i("WallsLayer.prototype._onDragLeftCancel",(function(t,...e){const n=t(...e);return e[0]instanceof PIXI.FederatedEvent&&(e[0].defaultPrevented=!1),n}),"MIXED"),game.release.generation<12&&(MouseInteractionManager=Tt),i("MouseInteractionManager.prototype.callback",(async function(t,e,...n){if("clearTimeouts"==e)return clearTimeout(Et),void clearTimeout(_t);if(F(W)&&console.log("TouchVTT: MIM:",this.object.constructor.name,e,"; PIXI event:",n[0].constructor.name,n[0].pointerType,n[0].type,"target="+n[0].target.constructor.name,"; native event:",n[0].nativeEvent?.constructor.name,n[0].nativeEvent?.pointerType,n[0].nativeEvent?.type,n[0].nativeEvent?.touchvttTrusted,"defaultPrevented="+n[0].nativeEvent?.defaultPrevented),["touch","pen"].includes(n[0].pointerType)||n[0].nativeEvent?.touchvttTrusted){if("touch"==n[0].pointerType||n[0].nativeEvent.touchvttTrusted){if(game.release.generation>=12&&"clickLeft2"==e)return await new Promise((t=>setTimeout(t,100))),canvas.app.view.dispatchEvent(new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,button:2})),t.call(this,e,...n);"clickLeft"==e?(clearTimeout(Et),clearTimeout(_t),Et=setTimeout((()=>{yt.touchIds.length<2&&a(n[0],"pointerdown",{button:2,buttons:2})}),F(G)),_t=setTimeout((()=>{yt.touchIds.length<2&&(canvas.currentMouseManager=this,this.callbacks.longPress(n[0],n[0].interactionData.origin))}),F(N))):["clickRight"].includes(e)||(clearTimeout(Et),clearTimeout(_t)),function(t,e){t.startsWith("dragLeft")&&!ut&&e.forEach((t=>{t.shiftKey=!0}))}(e,n)}(function(t,e){if("clickLeft"==t){const n=e[0].target;dt()!==I&&"select"===game.activeTool&&n instanceof Token&&function(t,e){return"function"==typeof t.can&&!t.can("clickLeft",e)}(n.mouseInteractionManager,t)&&function(t){const e=dt()===R;t.setTarget(!t.isTargeted,{releaseOthers:e})}(n)}})(e,n),"longPress"!=e||n[1]||(n[1]=n[0].interactionData.origin)}return t.call(this,e,...n)}),"MIXED"),i("game.keyboard.isModifierActive",(function(t,e){var n=t.call(this,e);return n||=function(t){return!(t!==KeyboardManager.MODIFIER_KEYS.CONTROL||"walls"!=ui.controls.activeControl||!ht)}(e),n}),"MIXED"),wt=rt.init()):console.info(`${t} is active, but core functionality has been disabled in the settings.`)})),Hooks.on("canvasReady",(function(){canvas.templates.preview.on("childAdded",bt.onTemplatePreviewCreated.bind(bt))})),Hooks.on("ready",(function(){if(F(E))try{const e=document.querySelector("canvas#board")||document.querySelector("body > canvas")||document.querySelector("canvas");e?(yt=et.init(e),function({touchPointerEventsManager:t}){null==canvas.hud.touchMeasurement&&(canvas.hud.touchMeasurement=new mt({touchPointerEventsManager:t}),i("Ruler.prototype._onMouseMove",(function(t,e,...n){return null!=e.interactionData&&null!=e.interactionData.destination&&(game.release.generation<12?e.interactionData.destination.originType=e.pointerType:e.interactionData.destination.originType=e.data?.originalEvent?.pointerType),t.call(this,e,...n)})),i("Ruler.prototype.measure",(function(t,e,...n){const s=t.call(this,e,...n);if(Array.isArray(s)&&ft(this)&&vt()!==k&&"touch"===e?.originType)if(s.length>0){const t=s[s.length-1];canvas.hud.touchMeasurement.show(t.ray.B)}else canvas.hud.touchMeasurement.clear();return s})),i("Ruler.prototype.clear",(function(t,...e){const n=t.call(this,...e);return ft(this)&&canvas.hud.touchMeasurement.clear(),n})))}({touchPointerEventsManager:yt}),bt.initMeasuredTemplateHud(yt),console.info(`${t} started successfully.`)):console.warn(`Failed to find canvas element. ${t} will not be available.`),["pointerdown","pointerup"].forEach((t=>{document.body.addEventListener(t,(t=>{t.isTrusted&&("mouse"==t.pointerType?Dt(!1):["touch","pen"].includes(t.pointerType)&&Dt(!0))}),!0)}))}catch(e){console.error(`Failed to initialize ${t}: `,e)}F(W)&&["pointerdown","pointerup","pointermove","pointercancel","pointerenter","pointerleave","pointerover","pointerout","touchstart","touchmove","touchend","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout"].forEach((e=>{document.body.addEventListener(e,(e=>{console.log(t+": "+e.target.tagName,e.type,e.pointerType,e.pointerId,"trusted:"+e.isTrusted+","+e.touchvttTrusted,"buttons:"+e.button+","+e.buttons,e.clientX,e.clientY)}),!0)}))}))})()})();